name: Build & Release

on:
  push:
    tags:
      - "v*.*.*"
  pull_request:
    branches: [main]

permissions:
  contents: write

env:
  APP_NAME: ns-drive
  WAILS_VERSION: v3.0.0-alpha.57

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            goos: darwin
            goarch: arm64
            artifact: ns-drive-darwin-arm64
          - os: macos-13
            goos: darwin
            goarch: amd64
            artifact: ns-drive-darwin-amd64
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            artifact: ns-drive-linux-amd64
          - os: windows-latest
            goos: windows
            goarch: amd64
            artifact: ns-drive-windows-amd64

    runs-on: ${{ matrix.os }}
    name: Build (${{ matrix.goos }}/${{ matrix.goarch }})

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache-dependency-path: desktop/go.sum

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      # Linux deps must be installed BEFORE wails3 CLI (CGO needs gtk/webkit headers)
      - name: Install Linux dependencies
        if: matrix.goos == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            build-essential \
            pkg-config

      - name: Install Wails v3 CLI
        run: go install github.com/wailsapp/wails/v3/cmd/wails3@${{ env.WAILS_VERSION }}

      - name: Install frontend dependencies
        working-directory: desktop/frontend
        run: bun install --frozen-lockfile

      - name: Generate bindings
        working-directory: desktop
        run: wails3 generate bindings -ts

      - name: Build frontend
        working-directory: desktop/frontend
        run: bun run build

      - name: Set version
        shell: bash
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_ENV
          else
            echo "VERSION=dev" >> $GITHUB_ENV
          fi
          echo "COMMIT=${GITHUB_SHA::8}" >> $GITHUB_ENV

      - name: Build binary
        working-directory: desktop
        shell: bash
        env:
          CGO_ENABLED: "1"
        run: |
          EXT=""
          if [ "${{ matrix.goos }}" = "windows" ]; then
            EXT=".exe"
          fi
          mkdir -p bin
          go build -trimpath \
            -ldflags="-s -w -X main.Version=${{ env.VERSION }} -X main.Commit=${{ env.COMMIT }}" \
            -o "bin/${APP_NAME}${EXT}"

      # --- macOS: create .app bundle ---
      - name: Create macOS app bundle
        if: matrix.goos == 'darwin'
        working-directory: desktop
        run: |
          APP_DIR="bin/${APP_NAME}.app"
          mkdir -p "${APP_DIR}/Contents/MacOS"
          mkdir -p "${APP_DIR}/Contents/Resources"
          cp "bin/${APP_NAME}" "${APP_DIR}/Contents/MacOS/"

          cat > "${APP_DIR}/Contents/Info.plist" << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
              <dict>
                  <key>CFBundlePackageType</key>
                  <string>APPL</string>
                  <key>CFBundleName</key>
                  <string>NS-Drive</string>
                  <key>CFBundleExecutable</key>
                  <string>${APP_NAME}</string>
                  <key>CFBundleIdentifier</key>
                  <string>com.nsdrive.app</string>
                  <key>CFBundleVersion</key>
                  <string>${VERSION}</string>
                  <key>CFBundleShortVersionString</key>
                  <string>${VERSION}</string>
                  <key>CFBundleIconFile</key>
                  <string>iconfile</string>
                  <key>LSMinimumSystemVersion</key>
                  <string>10.13.0</string>
                  <key>NSHighResolutionCapable</key>
                  <true/>
              </dict>
          </plist>
          EOF

          echo -n "APPL????" > "${APP_DIR}/Contents/PkgInfo"

          # Generate icons
          mkdir -p /tmp/ns-drive-icons.iconset
          sips -z 16 16 build/appicon.png --out /tmp/ns-drive-icons.iconset/icon_16x16.png >/dev/null 2>&1
          sips -z 32 32 build/appicon.png --out /tmp/ns-drive-icons.iconset/icon_16x16@2x.png >/dev/null 2>&1
          sips -z 32 32 build/appicon.png --out /tmp/ns-drive-icons.iconset/icon_32x32.png >/dev/null 2>&1
          sips -z 64 64 build/appicon.png --out /tmp/ns-drive-icons.iconset/icon_32x32@2x.png >/dev/null 2>&1
          sips -z 128 128 build/appicon.png --out /tmp/ns-drive-icons.iconset/icon_128x128.png >/dev/null 2>&1
          sips -z 256 256 build/appicon.png --out /tmp/ns-drive-icons.iconset/icon_128x128@2x.png >/dev/null 2>&1
          sips -z 256 256 build/appicon.png --out /tmp/ns-drive-icons.iconset/icon_256x256.png >/dev/null 2>&1
          sips -z 512 512 build/appicon.png --out /tmp/ns-drive-icons.iconset/icon_256x256@2x.png >/dev/null 2>&1
          sips -z 512 512 build/appicon.png --out /tmp/ns-drive-icons.iconset/icon_512x512.png >/dev/null 2>&1
          sips -z 1024 1024 build/appicon.png --out /tmp/ns-drive-icons.iconset/icon_512x512@2x.png >/dev/null 2>&1
          iconutil -c icns /tmp/ns-drive-icons.iconset -o "${APP_DIR}/Contents/Resources/iconfile.icns"
          rm -rf /tmp/ns-drive-icons.iconset

          # Ad-hoc sign
          codesign --force --deep --sign "-" "${APP_DIR}"

      # --- Package artifacts ---
      - name: Package (macOS)
        if: matrix.goos == 'darwin'
        working-directory: desktop
        run: |
          cd bin
          zip -r "../../${{ matrix.artifact }}.zip" "${APP_NAME}.app"

      - name: Package (Linux)
        if: matrix.goos == 'linux'
        working-directory: desktop
        run: |
          cd bin
          tar czf "../../${{ matrix.artifact }}.tar.gz" "${APP_NAME}"

      - name: Package (Windows)
        if: matrix.goos == 'windows'
        working-directory: desktop
        shell: bash
        run: |
          cd bin
          7z a "../../${{ matrix.artifact }}.zip" "${APP_NAME}.exe"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}.*

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    name: Create Release

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: ls -lR artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            artifacts/*
