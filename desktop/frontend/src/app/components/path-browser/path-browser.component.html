<div class="flex flex-wrap items-center gap-1" (clickOutside)="closeDropdown()">
  <!-- Root / button (always present) -->
  <div class="relative">
    <button
      type="button"
      class="px-2 py-1 text-sm font-bold bg-sys-bg border-2 border-sys-border shadow-neo-sm hover:bg-sys-accent/20 disabled:opacity-50 disabled:cursor-not-allowed"
      [class.border-sys-accent]="activeSegmentIndex === -1"
      [disabled]="disabled"
      (click)="onSegmentClick(-1)"
    >
      /
    </button>
    @if (activeSegmentIndex === -1) {
      <ng-container *ngTemplateOutlet="dropdownTpl"></ng-container>
    }
  </div>

  <!-- Path segments -->
  @for (segment of segments; track segment.fullPath; let i = $index) {
    <span class="text-sys-fg-muted text-sm select-none">/</span>
    <div class="relative">
      <button
        type="button"
        class="px-2 py-1 text-sm font-medium bg-sys-bg border-2 border-sys-border shadow-neo-sm hover:bg-sys-accent/20 disabled:opacity-50 disabled:cursor-not-allowed max-w-[150px] truncate"
        [class.border-sys-accent]="activeSegmentIndex === i"
        [disabled]="disabled || isLastSegmentFile(i)"
        (click)="onSegmentClick(i)"
      >
        {{ segment.name }}
      </button>
      @if (activeSegmentIndex === i) {
        <ng-container *ngTemplateOutlet="dropdownTpl"></ng-container>
      }
    </div>
  }

  @if (segments.length === 0 && placeholder) {
    <span class="text-sys-fg-tertiary text-sm select-none">{{ placeholder }}</span>
  }
</div>

<!-- Shared dropdown template -->
<ng-template #dropdownTpl>
  <div class="absolute z-50 left-0 top-full mt-1 bg-sys-bg border-2 border-sys-border shadow-neo max-h-48 overflow-auto min-w-[200px]">
    @if (dropdownLoading) {
      <div class="flex items-center justify-center p-3">
        <i class="pi pi-spin pi-spinner text-sys-fg-muted mr-2"></i>
        <span class="text-xs text-sys-fg-muted">Loading...</span>
      </div>
    } @else {
      @if (filterMode !== 'file') {
        <!-- eslint-disable-next-line @angular-eslint/template/click-events-have-key-events, @angular-eslint/template/interactive-supports-focus -->
        <div
          class="flex items-center gap-2 px-3 py-2 cursor-pointer hover:bg-sys-accent/20 text-sm"
          (click)="onSelectCurrentFolder()"
        >
          <i class="pi pi-folder text-sys-accent"></i>
          <span class="truncate text-sys-fg">.</span>
        </div>
      }
      @for (entry of dropdownEntries; track entry.name) {
        <!-- eslint-disable-next-line @angular-eslint/template/click-events-have-key-events, @angular-eslint/template/interactive-supports-focus -->
        <div
          class="flex items-center gap-2 px-3 py-2 cursor-pointer hover:bg-sys-accent/20 text-sm"
          (click)="onEntrySelect(entry)"
        >
          <i [class]="entry.is_dir ? 'pi pi-folder text-sys-accent' : 'pi pi-file text-sys-fg-muted'"></i>
          <span class="truncate" [class]="entry.is_dir ? 'text-sys-fg' : 'text-sys-fg-muted'">{{ entry.name }}</span>
        </div>
      }
    }
  </div>
</ng-template>
