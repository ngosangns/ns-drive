<!-- Profile Editor -->
<div class="flex flex-col h-full">
  <!-- Header Toolbar -->
  <p-toolbar>
    <ng-template #start>
      <p-button icon="pi pi-arrow-left" [text]="true" [rounded]="true" (onClick)="goBack()" />
      <span class="text-lg font-semibold text-gray-100 ml-2">Edit Profile</span>
      @if (profile) {
      <span class="text-sm text-gray-500 ml-2">{{ profile.name }}</span>
      }
    </ng-template>
    <ng-template #end>
      @if (profile) {
      <p-button [label]="(saveBtnText$ | async) ?? 'Save'" icon="pi pi-save" (onClick)="saveProfile()" size="small" />
      }
    </ng-template>
  </p-toolbar>

  @if (profile) {
  <!-- Tab Navigation -->
  <div class="flex border-b border-gray-700 bg-gray-800/50">
    @for (tab of editorTabs; track tab.id) {
    <p-button
      [label]="tab.label"
      [icon]="tab.icon"
      [text]="true"
      [rounded]="false"
      size="small"
      [severity]="activeTab === tab.id ? 'primary' : 'secondary'"
      [styleClass]="activeTab === tab.id
        ? 'border-b-2 border-primary-400 rounded-none'
        : 'rounded-none'"
      (onClick)="activeTab = tab.id"
    />
    }
  </div>

  <!-- Tab Content -->
  <div class="flex-1 overflow-auto p-4">
    <!-- General Tab -->
    @if (activeTab === 'general') {
    <div class="space-y-4 max-w-2xl mx-auto">
      <p-card>
        <label class="text-sm text-gray-400 mb-2 block">Profile Name</label>
        <input
          pInputText
          class="w-full"
          [(ngModel)]="profile.name"
          (ngModelChange)="onProfileFieldChange()"
          placeholder="Enter profile name"
        />
      </p-card>

      <!-- Source Path -->
      <p-card>
        <h3 class="text-sm font-medium text-gray-200 mb-3">
          <i class="pi pi-folder-open mr-2"></i>Source Path
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-gray-500 mb-1 block">Remote</label>
            <p-select
              [options]="getRemoteOptions()"
              [ngModel]="getFromRemote()"
              (ngModelChange)="updateFromPath($event, getFromPath())"
              optionLabel="label"
              optionValue="value"
              styleClass="w-full"
            />
          </div>
          <div>
            <label class="text-xs text-gray-500 mb-1 block">Path</label>
            <input
              pInputText
              class="w-full"
              [ngModel]="getFromPath()"
              (ngModelChange)="updateFromPath(getFromRemote(), $event)"
              placeholder="/source/path"
            />
          </div>
        </div>
      </p-card>

      <!-- Destination Path -->
      <p-card>
        <h3 class="text-sm font-medium text-gray-200 mb-3">
          <i class="pi pi-folder mr-2"></i>Destination Path
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-gray-500 mb-1 block">Remote</label>
            <p-select
              [options]="getRemoteOptions()"
              [ngModel]="getToRemote()"
              (ngModelChange)="updateToPath($event, getToPath())"
              optionLabel="label"
              optionValue="value"
              styleClass="w-full"
            />
          </div>
          <div>
            <label class="text-xs text-gray-500 mb-1 block">Path</label>
            <input
              pInputText
              class="w-full"
              [ngModel]="getToPath()"
              (ngModelChange)="updateToPath(getToRemote(), $event)"
              placeholder="/destination/path"
            />
          </div>
        </div>
      </p-card>
    </div>
    }

    <!-- Filters Tab -->
    @if (activeTab === 'filters') {
    <div class="space-y-4 max-w-2xl mx-auto">
      <!-- Include Paths -->
      <p-card>
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <i class="pi pi-check text-green-400"></i>
            <h3 class="text-sm font-medium text-gray-200">Include Paths</h3>
          </div>
          <p-button
            label="Add"
            icon="pi pi-plus"
            severity="secondary"
            size="small"
            (onClick)="addIncludePath()"
          />
        </div>
        @if (profile.included_paths.length === 0) {
        <p class="text-xs text-gray-500">All files included by default</p>
        } @else { @for (path of profile.included_paths; track $index; let i =
        $index) {
        <div class="flex items-center gap-2 mb-2">
          <p-select
            [options]="pathTypeOptions"
            [ngModel]="getIncludePathType(i)"
            (ngModelChange)="onIncludePathTypeChange(i, $event)"
            optionLabel="label"
            optionValue="value"
            styleClass="w-24!"
          />
          <input
            pInputText
            class="flex-1"
            [value]="getIncludePathValue(i)"
            (input)="onIncludePathValueChange(i, $event)"
            placeholder="path pattern"
          />
          <p-button
            icon="pi pi-minus"
            [rounded]="true"
            [text]="true"
            severity="danger"
            size="small"
            (onClick)="removeIncludePath(i)"
          />
        </div>
        } }
      </p-card>

      <!-- Exclude Paths -->
      <p-card>
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <i class="pi pi-times text-red-400"></i>
            <h3 class="text-sm font-medium text-gray-200">Exclude Paths</h3>
          </div>
          <p-button
            label="Add"
            icon="pi pi-plus"
            severity="secondary"
            size="small"
            (onClick)="addExcludePath()"
          />
        </div>
        @if (profile.excluded_paths.length === 0) {
        <p class="text-xs text-gray-500">No files excluded</p>
        } @else { @for (path of profile.excluded_paths; track $index; let i =
        $index) {
        <div class="flex items-center gap-2 mb-2">
          <p-select
            [options]="pathTypeOptions"
            [ngModel]="getExcludePathType(i)"
            (ngModelChange)="onExcludePathTypeChange(i, $event)"
            optionLabel="label"
            optionValue="value"
            styleClass="w-24!"
          />
          <input
            pInputText
            class="flex-1"
            [value]="getExcludePathValue(i)"
            (input)="onExcludePathValueChange(i, $event)"
            placeholder="path pattern"
          />
          <p-button
            icon="pi pi-minus"
            [rounded]="true"
            [text]="true"
            severity="danger"
            size="small"
            (onClick)="removeExcludePath(i)"
          />
        </div>
        } }
      </p-card>

      <!-- Size Filters -->
      <p-card>
        <h3 class="text-sm font-medium text-gray-200 mb-3">Size Filters</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-gray-500 mb-1 block">Min Size</label>
            <input
              pInputText
              class="w-full"
              [(ngModel)]="profile.min_size"
              (ngModelChange)="onProfileFieldChange()"
              placeholder="e.g. 100k, 10M"
            />
          </div>
          <div>
            <label class="text-xs text-gray-500 mb-1 block">Max Size</label>
            <input
              pInputText
              class="w-full"
              [(ngModel)]="profile.max_size"
              (ngModelChange)="onProfileFieldChange()"
              placeholder="e.g. 1G, 500M"
            />
          </div>
        </div>
      </p-card>

      <!-- Advanced Filters -->
      <p-card>
        <h3 class="text-sm font-medium text-gray-200 mb-3">Advanced Filters</h3>
        <div class="space-y-3">
          <div>
            <label class="text-xs text-gray-500 mb-1 block">Filter From File</label>
            <input
              pInputText
              class="w-full"
              [(ngModel)]="profile.filter_from_file"
              (ngModelChange)="onProfileFieldChange()"
              placeholder="Path to filter rules file"
            />
          </div>
          <div>
            <label class="text-xs text-gray-500 mb-1 block">Exclude If Present</label>
            <input
              pInputText
              class="w-full"
              [(ngModel)]="profile.exclude_if_present"
              (ngModelChange)="onProfileFieldChange()"
              placeholder="e.g. .nosync"
            />
          </div>
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-300">Use Regex</p>
              <p class="text-xs text-gray-500">Use regex for include/exclude patterns</p>
            </div>
            <p-toggleswitch
              [(ngModel)]="profile.use_regex"
              (onChange)="onProfileFieldChange()"
            ></p-toggleswitch>
          </div>
        </div>
      </p-card>
    </div>
    }

    <!-- Performance Tab -->
    @if (activeTab === 'performance') {
    <div class="space-y-4 max-w-2xl mx-auto">
      <p-card>
        <h3 class="text-sm font-medium text-gray-200 mb-3">
          <i class="pi pi-bolt mr-2"></i>Transfer Settings
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-gray-500 mb-1 block">Parallel Transfers</label>
            <p-select
              [options]="getNumberRangeOptions(1, 32)"
              [(ngModel)]="profile.parallel"
              (ngModelChange)="onProfileFieldChange()"
              optionLabel="label"
              optionValue="value"
              styleClass="w-full"
            />
          </div>
          <div>
            <label class="text-xs text-gray-500 mb-1 block">Bandwidth Limit (MB/s)</label>
            <p-select
              [options]="getNumberRangeOptions(1, 100)"
              [(ngModel)]="profile.bandwidth"
              (ngModelChange)="onProfileFieldChange()"
              optionLabel="label"
              optionValue="value"
              styleClass="w-full"
            />
          </div>
        </div>
      </p-card>

      <p-card>
        <h3 class="text-sm font-medium text-gray-200 mb-3">
          <i class="pi pi-cog mr-2"></i>Advanced Performance
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-gray-500 mb-1 block">Multi-Thread Streams</label>
            <p-inputnumber
              [(ngModel)]="profile.multi_thread_streams"
              (ngModelChange)="onProfileFieldChange()"
              placeholder="4"
              [min]="0"
              [max]="64"
              [showButtons]="true"
              styleClass="w-full"
            />
          </div>
          <div>
            <label class="text-xs text-gray-500 mb-1 block">Buffer Size</label>
            <input
              pInputText
              class="w-full"
              [(ngModel)]="profile.buffer_size"
              (ngModelChange)="onProfileFieldChange()"
              placeholder="e.g. 16M, 64M"
            />
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
          <div>
            <label class="text-xs text-gray-500 mb-1 block">Retries</label>
            <p-inputnumber
              [(ngModel)]="profile.retries"
              (ngModelChange)="onProfileFieldChange()"
              placeholder="3"
              [min]="0"
              [showButtons]="true"
              styleClass="w-full"
            />
          </div>
          <div>
            <label class="text-xs text-gray-500 mb-1 block">Low-Level Retries</label>
            <p-inputnumber
              [(ngModel)]="profile.low_level_retries"
              (ngModelChange)="onProfileFieldChange()"
              placeholder="10"
              [min]="0"
              [showButtons]="true"
              styleClass="w-full"
            />
          </div>
        </div>
        <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-700">
          <div>
            <p class="text-sm text-gray-300">Fast List</p>
            <p class="text-xs text-gray-500">Use recursive list if available (uses more memory)</p>
          </div>
          <p-toggleswitch
            [(ngModel)]="profile.fast_list"
            (onChange)="onProfileFieldChange()"
          ></p-toggleswitch>
        </div>
      </p-card>
    </div>
    }

    <!-- Advanced Tab -->
    @if (activeTab === 'advanced') {
    <div class="space-y-4 max-w-2xl mx-auto">
      <p-card>
        <h3 class="text-sm font-medium text-gray-200 mb-3">
          <i class="pi pi-cog mr-2"></i>Safety Settings
        </h3>
        <div class="space-y-3">
          <div>
            <label class="text-xs text-gray-500 mb-1 block">Backup Directory</label>
            <input
              pInputText
              class="w-full"
              [(ngModel)]="profile.backup_path"
              (ngModelChange)="onProfileFieldChange()"
              placeholder="Path to backup deleted/modified files"
            />
          </div>
          <div>
            <label class="text-xs text-gray-500 mb-1 block">Max Delete (files)</label>
            <p-inputnumber
              [(ngModel)]="profile.max_delete"
              (ngModelChange)="onProfileFieldChange()"
              placeholder="Unlimited"
              [min]="0"
              [showButtons]="true"
              styleClass="w-full"
            />
            <p class="text-xs text-gray-500 mt-1">Maximum number of files to delete. Leave empty for unlimited.</p>
          </div>
          <div>
            <label class="text-xs text-gray-500 mb-1 block">Max Duration</label>
            <input
              pInputText
              class="w-full"
              [(ngModel)]="profile.max_duration"
              (ngModelChange)="onProfileFieldChange()"
              placeholder="e.g. 1h30m, 45m"
            />
          </div>
          <div class="flex items-center justify-between pt-3 border-t border-gray-700">
            <div>
              <p class="text-sm text-gray-300">Immutable</p>
              <p class="text-xs text-gray-500">Do not modify files, fail if existing files differ</p>
            </div>
            <p-toggleswitch
              [(ngModel)]="profile.immutable"
              (onChange)="onProfileFieldChange()"
            ></p-toggleswitch>
          </div>
        </div>
      </p-card>

      <p-card>
        <h3 class="text-sm font-medium text-gray-200 mb-3">
          <i class="pi pi-cog mr-2"></i>Bi-Sync Settings
        </h3>
        <div>
          <label class="text-xs text-gray-500 mb-1 block">Conflict Resolution</label>
          <p-select
            [options]="conflictResolutionOptions"
            [(ngModel)]="profile.conflict_resolution"
            (ngModelChange)="onProfileFieldChange()"
            optionLabel="label"
            optionValue="value"
            styleClass="w-full"
          />
          <p class="text-xs text-gray-500 mt-1">
            How to resolve conflicts during bi-directional sync
          </p>
        </div>
      </p-card>
    </div>
    }
  </div>
  } @else {
  <!-- Loading State -->
  <div class="flex flex-col items-center justify-center flex-1 text-gray-500">
    <div
      class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mb-3"
    ></div>
    <p class="text-sm">Loading profile...</p>
  </div>
  }
</div>
