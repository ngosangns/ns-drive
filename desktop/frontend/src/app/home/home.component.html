<!-- Dashboard Layout -->
<div
  class="page-container content-spacing"
  *ngIf="tabService.tabsValue.length === 0"
>
  <!-- Welcome State -->
  <mat-card class="card-spacing">
    <mat-card-header>
      <mat-card-title>Welcome to NS Drive Dashboard</mat-card-title>
      <mat-card-subtitle>
        Start by creating your first sync operation
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <p>
        Sync operations allow you to synchronize files between local directories
        and cloud storage services. Each operation runs independently with its
        own configuration and profile.
      </p>

      <mat-list>
        <mat-list-item>
          <mat-icon matListItemIcon color="primary">sync</mat-icon>
          <div matListItemTitle>Real-time synchronization</div>
        </mat-list-item>
        <mat-list-item>
          <mat-icon matListItemIcon color="primary">cloud</mat-icon>
          <div matListItemTitle>Multiple cloud providers</div>
        </mat-list-item>
        <mat-list-item>
          <mat-icon matListItemIcon color="primary">settings</mat-icon>
          <div matListItemTitle>Customizable profiles</div>
        </mat-list-item>
      </mat-list>
    </mat-card-content>

    <mat-card-actions align="end">
      <button mat-raised-button color="primary" (click)="createTab()">
        <mat-icon>add</mat-icon>
        Create First Operation
      </button>
    </mat-card-actions>
  </mat-card>
</div>

<!-- Operations Dashboard -->
<div *ngIf="tabService.tabsValue.length > 0">
  <!-- Operations Header -->
  <mat-toolbar>
    <mat-icon>sync</mat-icon>
    <span>Sync Operations</span>
    <span class="spacer"></span>
  </mat-toolbar>

  <!-- Tab Navigation -->
  <mat-tab-group
    [selectedIndex]="getActiveTabIndex()"
    (selectedIndexChange)="onTabChange($event)"
  >
    <mat-tab
      *ngFor="
        let tab of tabService.tabsValue;
        let i = index;
        trackBy: trackByTabId
      "
    >
      <ng-template mat-tab-label>
        <span>{{ tab?.name || "Operation " + (i + 1) }}</span>
        <button
          mat-icon-button
          [matMenuTriggerFor]="tabMenu"
          (click)="$event.stopPropagation(); setCurrentTabForMenu(tab.id)"
          *ngIf="tab && tab.id"
        >
          <mat-icon>more_vert</mat-icon>
        </button>
      </ng-template>

      <!-- Tab Content -->
      <div class="page-container">
        <mat-card class="card-spacing">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>settings</mat-icon>
              <span>Operation Controls</span>
            </mat-card-title>
            <mat-card-subtitle>
              Configure and execute sync operations
            </mat-card-subtitle>
          </mat-card-header>

          <mat-card-content>
            <!-- Profile Selection -->
            <mat-form-field appearance="outline" class="form-spacing">
              <mat-label>Sync Profile</mat-label>
              <mat-select
                [value]="tab?.selectedProfileIndex"
                (selectionChange)="changeProfileTab($event.value, tab?.id)"
                [disabled]="!tab || !tab.id"
              >
                <mat-option [value]="null">
                  <em>No profile selected</em>
                </mat-option>
                <mat-option
                  *ngFor="
                    let profile of appService.configInfo$.value.profiles;
                    let idx = index
                  "
                  [value]="idx"
                >
                  {{ profile.name }}
                </mat-option>
              </mat-select>
              <mat-icon matSuffix>folder_shared</mat-icon>
            </mat-form-field>

            <!-- Profile Information Display -->
            <div
              *ngIf="getSelectedProfile(tab) as selectedProfile"
              class="profile-info-section"
            >
              <h4>Profile Details</h4>
              <mat-list>
                <mat-list-item>
                  <mat-icon matListItemIcon>sync_alt</mat-icon>
                  <div matListItemTitle>From</div>
                  <div matListItemLine>
                    {{ selectedProfile.from || "Not configured" }}
                  </div>
                </mat-list-item>
                <mat-list-item>
                  <mat-icon matListItemIcon>sync_alt</mat-icon>
                  <div matListItemTitle>To</div>
                  <div matListItemLine>
                    {{ selectedProfile.to || "Not configured" }}
                  </div>
                </mat-list-item>
                <mat-list-item>
                  <mat-icon matListItemIcon>speed</mat-icon>
                  <div matListItemTitle>Bandwidth</div>
                  <div matListItemLine>
                    {{ selectedProfile.bandwidth || "Unlimited" }}MB/s
                  </div>
                </mat-list-item>
                <mat-list-item>
                  <mat-icon matListItemIcon>settings</mat-icon>
                  <div matListItemTitle>Parallel</div>
                  <div matListItemLine>
                    {{ selectedProfile.parallel || 1 }} connections
                  </div>
                </mat-list-item>
              </mat-list>
            </div>
          </mat-card-content>

          <!-- Action Buttons -->
          <mat-card-actions *ngIf="validateTabProfileIndex(tab)">
            <button
              mat-raised-button
              [color]="tab.currentAction === Action.Pull ? 'warn' : 'primary'"
              [disabled]="
                (!validateTabProfileIndex(tab) &&
                  tab.currentAction !== Action.Pull) ||
                tab.isStopping
              "
              (click)="
                tab.currentAction !== Action.Pull
                  ? pullTab(tab.id)
                  : stopCommandTab(tab.id)
              "
            >
              <mat-icon>{{
                tab.isStopping
                  ? "hourglass_empty"
                  : tab.currentAction === Action.Pull
                  ? "stop"
                  : "download"
              }}</mat-icon>
              {{
                tab.isStopping
                  ? "Stopping..."
                  : tab.currentAction === Action.Pull
                  ? "Stop Pull"
                  : "Pull"
              }}
            </button>

            <button
              mat-raised-button
              [color]="tab.currentAction === Action.Push ? 'warn' : 'accent'"
              [disabled]="
                !validateTabProfileIndex(tab) &&
                tab.currentAction !== Action.Push
              "
              (click)="
                tab.currentAction !== Action.Push
                  ? pushTab(tab.id)
                  : stopCommandTab(tab.id)
              "
            >
              <mat-icon>{{
                tab.currentAction === Action.Push ? "stop" : "upload"
              }}</mat-icon>
              {{ tab.currentAction === Action.Push ? "Stop Push" : "Push" }}
            </button>

            <button
              mat-raised-button
              [color]="tab.currentAction === Action.Bi ? 'warn' : 'primary'"
              [disabled]="
                !validateTabProfileIndex(tab) && tab.currentAction !== Action.Bi
              "
              (click)="
                tab.currentAction !== Action.Bi
                  ? biTab(tab.id)
                  : stopCommandTab(tab.id)
              "
            >
              <mat-icon>{{
                tab.currentAction === Action.Bi ? "stop" : "sync"
              }}</mat-icon>
              {{ tab.currentAction === Action.Bi ? "Stop Sync" : "Sync" }}
            </button>

            <button
              mat-raised-button
              color="warn"
              [disabled]="
                !validateTabProfileIndex(tab) &&
                tab.currentAction !== Action.BiResync
              "
              (click)="
                tab.currentAction !== Action.BiResync
                  ? biResyncTab(tab.id)
                  : stopCommandTab(tab.id)
              "
            >
              <mat-icon>{{
                tab.currentAction === Action.BiResync ? "stop" : "refresh"
              }}</mat-icon>
              {{
                tab.currentAction === Action.BiResync ? "Stop Resync" : "Resync"
              }}
            </button>
          </mat-card-actions>

          <!-- Status Display -->
          <mat-card-content *ngIf="tab.currentAction">
            <mat-progress-bar mode="indeterminate"></mat-progress-bar>
            <mat-chip-set>
              <mat-chip>
                <mat-icon matChipAvatar>{{
                  getActionIcon(tab.currentAction)
                }}</mat-icon>
                {{ getActionLabel(tab.currentAction) }}
              </mat-chip>
            </mat-chip-set>
          </mat-card-content>
        </mat-card>

        <!-- Info Cards -->
        <mat-card class="card-spacing">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>folder</mat-icon>
              <span>Working Directory</span>
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <code>{{ (appService.configInfo$ | async)?.working_dir }}</code>
          </mat-card-content>
        </mat-card>

        <!-- Console Output -->
        <mat-card class="card-spacing">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>terminal</mat-icon>
              <span>Console Output</span>
            </mat-card-title>
            <span class="spacer"></span>
            <button
              mat-icon-button
              (click)="clearTabOutput(tab.id)"
              matTooltip="Clear output"
            >
              <mat-icon>auto_delete</mat-icon>
            </button>
          </mat-card-header>
          <mat-card-content>
            <pre>{{ tab.data.join("\n") || "No output yet..." }}</pre>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>
  </mat-tab-group>

  <!-- Shared Tab Menu -->
  <mat-menu #tabMenu="matMenu">
    <button mat-menu-item (click)="startRenameTab(currentTabIdForMenu)">
      <mat-icon>edit</mat-icon>
      <span>Rename</span>
    </button>
    <button mat-menu-item (click)="deleteTab(currentTabIdForMenu)">
      <mat-icon>delete</mat-icon>
      <span>Delete</span>
    </button>
  </mat-menu>

  <!-- Floating Action Button for Create Tab -->
  <button
    mat-fab
    color="primary"
    (click)="createTab()"
    class="fab-button"
    matTooltip="Add new operation"
  >
    <mat-icon>add</mat-icon>
  </button>
</div>

<!-- Rename Tab Dialog -->
<ng-template #renameDialog>
  <h2 mat-dialog-title>Rename Tab</h2>
  <mat-dialog-content>
    <mat-form-field appearance="outline" style="width: 100%">
      <mat-label>Tab Name</mat-label>
      <input
        matInput
        [(ngModel)]="renameDialogData.newName"
        (keydown.enter)="confirmRename()"
        id="renameDialogInput"
        #renameDialogInput
      />
    </mat-form-field>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button (click)="cancelRename()">Cancel</button>
    <button mat-raised-button color="primary" (click)="confirmRename()">
      Rename
    </button>
  </mat-dialog-actions>
</ng-template>
