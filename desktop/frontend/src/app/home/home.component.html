<!-- Operations Dashboard -->
<div class="flex flex-col h-full">
  <!-- Header -->
  <p-toolbar>
    <ng-template #start>
      <div class="flex items-center gap-3">
        <i class="pi pi-play text-primary-400"></i>
        <h1 class="text-lg font-semibold text-gray-100">Operations</h1>
        <span class="text-sm text-gray-500"
          >{{ tabService.tabsValue.length }} tab{{
            tabService.tabsValue.length !== 1 ? "s" : ""
          }}</span
        >
      </div>
    </ng-template>
    <ng-template #end>
      <p-button
        label="New Tab"
        icon="pi pi-plus"
        size="small"
        (onClick)="createTab()"
      />
    </ng-template>
  </p-toolbar>

  @if (tabService.tabsValue.length === 0) {
  <!-- Empty State -->
  <div
    class="flex flex-col items-center justify-center flex-1 text-gray-500"
  >
    <i class="pi pi-play text-5xl mb-3 opacity-30"></i>
    <p class="text-sm mb-3">No operations configured</p>
    <p-button
      label="Create First Operation"
      size="small"
      (onClick)="createTab()"
    />
  </div>
  } @else {
  <!-- Tab Bar -->
  <div class="flex items-center border-b border-gray-700 bg-gray-800/50">
    <nav class="flex overflow-x-auto hide-scrollbar flex-1">
      @for (tab of tabService.tabsValue; track trackByTabId(i, tab); let i =
      $index) {
      <button
        [class]="
          getActiveTabIndex() === i
            ? 'flex items-center gap-2 px-4 py-2.5 text-sm font-medium border-b-2 border-blue-400 text-blue-400 bg-transparent whitespace-nowrap'
            : 'flex items-center gap-2 px-4 py-2.5 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-gray-200 hover:bg-gray-800/50 whitespace-nowrap'
        "
        (click)="onTabChange(i)"
      >
        <div class="flex items-center gap-2">
          <span>{{ tab?.name || "Tab " + (i + 1) }}</span>
          @if (tab && tab.id) {
          <div class="flex items-center gap-1">
            <button
              class="p-0.5 rounded hover:bg-gray-600 text-gray-500 hover:text-gray-300"
              (click)="$event.stopPropagation(); startRenameTab(tab.id)"
              title="Rename"
            >
              <i class="pi pi-pencil text-xs"></i>
            </button>
            <button
              class="p-0.5 rounded hover:bg-red-900/50 text-gray-500 hover:text-red-400"
              (click)="$event.stopPropagation(); deleteTab(tab.id)"
              title="Delete"
            >
              <i class="pi pi-trash text-xs"></i>
            </button>
          </div>
          }
        </div>
      </button>
      }
    </nav>
  </div>

  <!-- Tab Content -->
  <div class="flex-1 overflow-auto p-4">
    @for (tab of tabService.tabsValue; track trackByTabId(i, tab); let i =
    $index) { @if (getActiveTabIndex() === i) {
    <div class="space-y-4">
      <!-- Profile Selection -->
      <p-card>
        <label class="text-sm text-gray-400 mb-2 block">Sync Profile</label>
        <p-select
          [options]="getProfileOptions()"
          [ngModel]="getTabProfileValue(tab)"
          (ngModelChange)="onProfileChange($event, tab?.id)"
          optionLabel="label"
          optionValue="value"
          [disabled]="!tab || !tab.id"
          styleClass="w-full"
          placeholder="No profile selected"
        />
      </p-card>

      <!-- Operation Type Selector -->
      <p-card>
        <label class="text-sm text-gray-400 mb-2 block">Operation Type</label>
        <div class="flex rounded-lg bg-gray-900 p-1 gap-1">
          @for (opType of operationTypes; track opType.value) {
          <button
            class="flex-1 text-sm py-2 px-3 rounded-md transition-colors"
            [class]="
              tab.operationType === opType.value
                ? 'bg-primary-600 text-white'
                : 'text-gray-400 hover:text-gray-200 hover:bg-gray-700'
            "
            (click)="setOperationType(tab.id, opType.value)"
          >
            {{ opType.label }}
          </button>
          }
        </div>

        <!-- Direction Selector (only for Sync) -->
        @if (tab.operationType === 'sync' || !tab.operationType) {
        <label class="text-sm text-gray-400 mt-3 mb-2 block">Direction</label>
        <div class="flex rounded-lg bg-gray-900 p-1 gap-1">
          @for (dir of syncDirections; track dir.value) {
          <button
            class="flex-1 text-sm py-2 px-3 rounded-md transition-colors flex items-center justify-center gap-1.5"
            [class]="
              tab.syncDirection === dir.value
                ? 'bg-primary-600 text-white'
                : 'text-gray-400 hover:text-gray-200 hover:bg-gray-700'
            "
            (click)="setSyncDirection(tab.id, dir.value)"
          >
            <i [class]="dir.icon" class="text-sm"></i>
            {{ dir.label }}
          </button>
          }
        </div>
        }

        <!-- Dry Run Toggle -->
        <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-700">
          <div>
            <p class="text-sm text-gray-300">Dry Run</p>
            <p class="text-xs text-gray-500">Preview changes without executing</p>
          </div>
          <p-toggleswitch
            [ngModel]="tab.dryRun || false"
            (onChange)="toggleDryRun(tab.id)"
          ></p-toggleswitch>
        </div>
      </p-card>

      <!-- Start/Stop Button -->
      @if (validateTabProfileIndex(tab)) {
      <div class="flex gap-3">
        <p-button
          class="flex-1"
          styleClass="w-full"
          [label]="
            tab.isStopping
              ? 'Stopping...'
              : tab.currentAction
              ? 'Stop'
              : (tab.dryRun ? 'Dry Run' : 'Start') +
                ' ' +
                getOperationLabel(tab)
          "
          [icon]="
            tab.isStopping
              ? 'pi pi-clock'
              : tab.currentAction
              ? 'pi pi-stop-circle'
              : 'pi pi-play'
          "
          [severity]="tab.currentAction ? 'danger' : 'primary'"
          [disabled]="tab.isStopping"
          (onClick)="tab.currentAction ? stopCommandTab(tab.id) : startOperation(tab)"
        />
      </div>
      }

      <!-- Sync Status Display -->
      <app-sync-status
        [syncStatus]="tab.syncStatus || null"
        [showTitle]="true"
      ></app-sync-status>

      <!-- Operation Log -->
      @if (tab.data && tab.data.length > 0) {
      <p-card>
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <i class="pi pi-code text-gray-400"></i>
            <span class="text-sm font-medium text-gray-300">
              Operation Log
            </span>
          </div>
          <button
            class="p-1 rounded hover:bg-gray-700 text-gray-500 hover:text-gray-300"
            (click)="clearTabOutput(tab.id)"
            title="Clear output"
          >
            <i class="pi pi-eraser"></i>
          </button>
        </div>
        <div
          class="bg-gray-900 rounded-lg p-3 max-h-64 overflow-y-auto"
        >
          <div class="font-mono text-xs text-green-400 whitespace-pre-wrap">
            @for (line of tab.data; track $index) {
            <div>{{ line }}</div>
            }
          </div>
        </div>
      </p-card>
      }
    </div>
    } }
  </div>
  }
</div>

<!-- Rename Tab Dialog (PrimeNG) -->
<p-dialog
  header="Rename Tab"
  [(visible)]="showRenameDialog"
  [modal]="true"
  [style]="{ width: '24rem' }"
  [closable]="true"
  (onHide)="cancelRename()"
>
  <div class="mb-4">
    <label class="text-sm text-gray-400 mb-1 block">Tab Name</label>
    <input
      pInputText
      type="text"
      class="w-full"
      [(ngModel)]="renameDialogData.newName"
      (keydown.enter)="confirmRename()"
    />
  </div>
  <div class="flex justify-end gap-2">
    <p-button
      label="Cancel"
      severity="secondary"
      size="small"
      (onClick)="cancelRename()"
    />
    <p-button
      label="Rename"
      size="small"
      (onClick)="confirmRename()"
    />
  </div>
</p-dialog>
