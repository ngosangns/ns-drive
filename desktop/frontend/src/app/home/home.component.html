<!-- Operations Dashboard -->
<div class="flex flex-col h-full">
  <!-- Header -->
  <div
    class="flex items-center justify-between p-4 border-b border-gray-700"
  >
    <div class="flex items-center gap-3">
      <lucide-icon
        [img]="PlayIcon"
        class="w-5 h-5 text-primary-400"
      ></lucide-icon>
      <h1 class="text-lg font-semibold text-gray-100">Operations</h1>
      <span class="text-sm text-gray-500"
        >{{ tabService.tabsValue.length }} tab{{
          tabService.tabsValue.length !== 1 ? "s" : ""
        }}</span
      >
    </div>
    <button
      class="btn-primary flex items-center gap-1.5 text-sm"
      (click)="createTab()"
    >
      <lucide-icon [img]="PlusIcon" class="w-4 h-4"></lucide-icon>
      New Tab
    </button>
  </div>

  @if (tabService.tabsValue.length === 0) {
  <!-- Empty State -->
  <div
    class="flex flex-col items-center justify-center flex-1 text-gray-500"
  >
    <lucide-icon
      [img]="PlayIcon"
      class="w-12 h-12 mb-3 opacity-30"
    ></lucide-icon>
    <p class="text-sm mb-3">No operations configured</p>
    <button class="btn-primary text-sm" (click)="createTab()">
      Create First Operation
    </button>
  </div>
  } @else {
  <!-- Tab Bar -->
  <div class="flex items-center border-b border-gray-700 bg-gray-800/50">
    <nav class="flex overflow-x-auto hide-scrollbar flex-1">
      @for (tab of tabService.tabsValue; track trackByTabId(i, tab); let i =
      $index) {
      <button
        [class]="
          getActiveTabIndex() === i
            ? 'tab-button-active whitespace-nowrap'
            : 'tab-button whitespace-nowrap'
        "
        (click)="onTabChange(i)"
      >
        <div class="flex items-center gap-2">
          <span>{{ tab?.name || "Tab " + (i + 1) }}</span>
          @if (tab && tab.id) {
          <div class="flex items-center gap-1">
            <button
              class="p-0.5 rounded hover:bg-gray-600 text-gray-500 hover:text-gray-300"
              (click)="$event.stopPropagation(); startRenameTab(tab.id)"
              title="Rename"
            >
              <lucide-icon [img]="EditIcon" class="w-3 h-3"></lucide-icon>
            </button>
            <button
              class="p-0.5 rounded hover:bg-red-900/50 text-gray-500 hover:text-red-400"
              (click)="$event.stopPropagation(); deleteTab(tab.id)"
              title="Delete"
            >
              <lucide-icon [img]="Trash2Icon" class="w-3 h-3"></lucide-icon>
            </button>
          </div>
          }
        </div>
      </button>
      }
    </nav>
  </div>

  <!-- Tab Content -->
  <div class="flex-1 overflow-auto p-4">
    @for (tab of tabService.tabsValue; track trackByTabId(i, tab); let i =
    $index) { @if (getActiveTabIndex() === i) {
    <div class="space-y-4">
      <!-- Profile Selection -->
      <div class="panel">
        <label class="text-sm text-gray-400 mb-2 block">Sync Profile</label>
        <select
          id="profile-select-{{ tab?.id }}"
          class="select-field"
          [value]="getTabProfileValue(tab)"
          (change)="onProfileChange($event, tab?.id)"
          [disabled]="!tab || !tab.id"
        >
          <option [value]="null">No profile selected</option>
          @for (profile of appService.configInfo$.value.profiles; track
          profile; let idx = $index) {
          <option
            [value]="idx"
            [selected]="tab?.selectedProfileIndex === idx"
          >
            {{ profile.name }}
          </option>
          }
        </select>
      </div>

      <!-- Operation Type Selector -->
      <div class="panel">
        <label class="text-sm text-gray-400 mb-2 block">Operation Type</label>
        <div class="flex rounded-lg bg-gray-900 p-1 gap-1">
          @for (opType of operationTypes; track opType.value) {
          <button
            class="flex-1 text-sm py-2 px-3 rounded-md transition-colors"
            [class]="
              tab.operationType === opType.value
                ? 'bg-primary-600 text-white'
                : 'text-gray-400 hover:text-gray-200 hover:bg-gray-700'
            "
            (click)="setOperationType(tab.id, opType.value)"
          >
            {{ opType.label }}
          </button>
          }
        </div>

        <!-- Direction Selector (only for Sync) -->
        @if (tab.operationType === 'sync' || !tab.operationType) {
        <label class="text-sm text-gray-400 mt-3 mb-2 block">Direction</label>
        <div class="flex rounded-lg bg-gray-900 p-1 gap-1">
          @for (dir of syncDirections; track dir.value) {
          <button
            class="flex-1 text-sm py-2 px-3 rounded-md transition-colors flex items-center justify-center gap-1.5"
            [class]="
              tab.syncDirection === dir.value
                ? 'bg-primary-600 text-white'
                : 'text-gray-400 hover:text-gray-200 hover:bg-gray-700'
            "
            (click)="setSyncDirection(tab.id, dir.value)"
          >
            <lucide-icon [img]="dir.icon" class="w-4 h-4"></lucide-icon>
            {{ dir.label }}
          </button>
          }
        </div>
        }

        <!-- Dry Run Toggle -->
        <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-700">
          <div>
            <p class="text-sm text-gray-300">Dry Run</p>
            <p class="text-xs text-gray-500">Preview changes without executing</p>
          </div>
          <p-toggleswitch
            [ngModel]="tab.dryRun || false"
            (onChange)="toggleDryRun(tab.id)"
          ></p-toggleswitch>
        </div>
      </div>

      <!-- Start/Stop Button -->
      @if (validateTabProfileIndex(tab)) {
      <div class="flex gap-3">
        <button
          class="flex-1 flex items-center justify-center gap-2 py-3 rounded-lg font-medium transition-colors text-sm"
          [class]="
            tab.currentAction
              ? 'bg-red-600 hover:bg-red-700 text-white'
              : 'bg-primary-600 hover:bg-primary-700 text-white'
          "
          [disabled]="tab.isStopping"
          (click)="tab.currentAction ? stopCommandTab(tab.id) : startOperation(tab)"
        >
          <lucide-icon
            [img]="
              tab.isStopping
                ? ClockIcon
                : tab.currentAction
                ? StopCircleIcon
                : PlayIcon
            "
            class="w-5 h-5"
          ></lucide-icon>
          {{
            tab.isStopping
              ? "Stopping..."
              : tab.currentAction
              ? "Stop"
              : (tab.dryRun ? "Dry Run" : "Start") +
                " " +
                getOperationLabel(tab)
          }}
        </button>
      </div>
      }

      <!-- Sync Status Display -->
      <app-sync-status
        [syncStatus]="tab.syncStatus || null"
        [showTitle]="true"
      ></app-sync-status>

      <!-- Operation Log -->
      @if (tab.data && tab.data.length > 0) {
      <div class="panel">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <lucide-icon
              [img]="TerminalIcon"
              class="w-4 h-4 text-gray-400"
            ></lucide-icon>
            <span class="text-sm font-medium text-gray-300">
              Operation Log
            </span>
          </div>
          <button
            class="p-1 rounded hover:bg-gray-700 text-gray-500 hover:text-gray-300"
            (click)="clearTabOutput(tab.id)"
            title="Clear output"
          >
            <lucide-icon [img]="EraseIcon" class="w-4 h-4"></lucide-icon>
          </button>
        </div>
        <div
          class="bg-gray-900 rounded-lg p-3 max-h-64 overflow-y-auto"
        >
          <div class="font-mono text-xs text-green-400 whitespace-pre-wrap">
            @for (line of tab.data; track $index) {
            <div>{{ line }}</div>
            }
          </div>
        </div>
      </div>
      }
    </div>
    } }
  </div>
  }
</div>

<!-- Rename Tab Dialog (PrimeNG) -->
<p-dialog
  header="Rename Tab"
  [(visible)]="showRenameDialog"
  [modal]="true"
  [style]="{ width: '24rem' }"
  [closable]="true"
  (onHide)="cancelRename()"
>
  <div class="mb-4">
    <label class="text-sm text-gray-400 mb-1 block">Tab Name</label>
    <input
      type="text"
      class="input-field"
      [(ngModel)]="renameDialogData.newName"
      (keydown.enter)="confirmRename()"
    />
  </div>
  <div class="flex justify-end gap-2">
    <button class="btn-secondary text-sm" (click)="cancelRename()">Cancel</button>
    <button class="btn-primary text-sm" (click)="confirmRename()">Rename</button>
  </div>
</p-dialog>
