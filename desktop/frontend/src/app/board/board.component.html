@if (viewMode === 'list') {
<!-- ========== LIST VIEW ========== -->
<div class="flex flex-col h-full">
  <p-toolbar>
    <ng-template #start>
      <div class="flex items-center gap-3">
        <i class="pi pi-sitemap text-primary-400"></i>
        <h1 class="text-lg font-semibold text-gray-100">Boards</h1>
        @if (boards.length) {
        <span class="text-sm text-gray-500">({{ boards.length }})</span>
        }
      </div>
    </ng-template>
    <ng-template #end>
      <p-button
        icon="pi pi-plus"
        label="New Board"
        size="small"
        (onClick)="createNewBoard()"
      ></p-button>
    </ng-template>
  </p-toolbar>

  <div class="flex-1 overflow-auto p-4">
    <div class="max-w-4xl mx-auto">
      @if (boards.length) {
      <div class="space-y-3" role="list">
        @for (board of boards; track board.id) {
        <p-card
          styleClass="group hover:bg-gray-700 transition-colors duration-200 cursor-pointer"
          (click)="openBoard(board)"
        >
          <div class="flex items-center gap-3">
            <div class="shrink-0">
              <div class="w-10 h-10 bg-gray-700 group-hover:bg-gray-600 rounded-lg flex items-center justify-center transition-colors">
                <i class="pi pi-sitemap text-primary-400"></i>
              </div>
            </div>
            <div class="flex-1 min-w-0">
              <h3 class="text-sm font-medium text-gray-200 truncate">
                {{ board.name || '(Unnamed board)' }}
              </h3>
              <p class="text-xs text-gray-500 mt-0.5">{{ getBoardSummary(board) }}</p>
            </div>
            <div class="flex items-center gap-1 shrink-0 opacity-0 group-hover:opacity-100 transition-opacity">
              <p-button
                icon="pi pi-trash"
                severity="danger"
                [text]="true"
                [rounded]="true"
                size="small"
                pTooltip="Delete"
                (onClick)="deleteBoardConfirm(board); $event.stopPropagation()"
              ></p-button>
            </div>
          </div>
        </p-card>
        }
      </div>
      } @else {
      <!-- Empty state -->
      <div class="flex flex-col items-center justify-center py-16 text-gray-500">
        <div class="w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mb-4">
          <i class="pi pi-sitemap text-3xl text-gray-400"></i>
        </div>
        <h2 class="text-xl font-bold text-gray-100 mb-2">No Boards</h2>
        <p class="text-gray-400 mb-6">Create a board to start building sync flows</p>
        <p-button
          icon="pi pi-plus"
          label="Create Board"
          (onClick)="createNewBoard()"
        ></p-button>
      </div>
      }
    </div>
  </div>
</div>
} @else {
<!-- ========== EDITOR VIEW ========== -->
<div class="flex flex-col h-full">
  <p-toolbar>
    <ng-template #start>
      <div class="flex items-center gap-3 min-w-0 flex-1">
        <p-button
          icon="pi pi-arrow-left"
          severity="secondary"
          [text]="true"
          [rounded]="true"
          size="small"
          pTooltip="Back to boards"
          (onClick)="backToList()"
        ></p-button>
        <span class="text-lg font-semibold text-gray-100 truncate min-w-0 flex-1">
          {{ activeBoard?.name || '(Unnamed board)' }}
        </span>
        @if (isExecuting) {
        <span class="text-xs text-yellow-400 shrink-0">
          <i class="pi pi-spin pi-spinner mr-1"></i>Executing...
        </span>
        }
        <p-button
          icon="pi pi-cog"
          severity="secondary"
          [text]="true"
          [rounded]="true"
          size="small"
          pTooltip="Settings"
          (onClick)="settingsMenu.toggle($event)"
          styleClass="shrink-0"
        ></p-button>
        <p-menu #settingsMenu [model]="boardSettingsMenuItems" [popup]="true"></p-menu>
      </div>
    </ng-template>
  </p-toolbar>
  @if (activeBoard && !isExecuting && availableRemotes.length) {
  <div class="flex items-center gap-2 px-4 py-2 bg-gray-800 border-b border-gray-700 flex-wrap">
    <span class="text-xs text-gray-500 mr-1">Click to add:</span>
    @for (remote of availableRemotes; track remote.value) {
    <span
      class="px-2 py-1 text-xs font-medium rounded-full bg-gray-700 text-gray-300 border border-gray-600 cursor-pointer hover:bg-gray-600 hover:border-gray-500 transition-colors select-none"
      tabindex="0"
      role="button"
      (click)="onRemoteClick(remote)"
      (keydown.enter)="onRemoteClick(remote)"
      [pTooltip]="'Add ' + remote.label + ' to board'"
    >
      <i class="pi pi-cloud mr-1 text-primary-400"></i>{{ remote.label }}
    </span>
    }
  </div>
  }

  <!-- Canvas Area -->
  <div class="flex-1 overflow-hidden relative">
    @if (activeBoard) {
    <app-board-canvas
      [nodes]="activeBoard.nodes || []"
      [edges]="activeBoard.edges || []"
      [selectedNodeId]="(boardService.selectedNodeId$ | async) ?? null"
      [selectedEdgeId]="(boardService.selectedEdgeId$ | async) ?? null"
      [executionStatus]="(boardService.executionStatus$ | async) ?? null"
      [disabled]="isExecuting"
      [remoteProviders]="remoteProviders"
      (nodeSelected)="isExecuting ? null : boardService.selectNode($event)"
      (nodeDoubleClicked)="isExecuting ? null : openNodeEditDialog($event)"
      (edgeSelected)="isExecuting ? null : boardService.selectEdge($event)"
      (edgeDoubleClicked)="isExecuting ? null : openEdgeDialog($event)"
      (nodeMoved)="isExecuting ? null : boardService.moveNode($event.nodeId, $event.x, $event.y)"
      (edgeCreated)="isExecuting ? null : boardService.addEdge($event.sourceId, $event.targetId)"
      (edgeReconnected)="isExecuting ? null : boardService.reconnectEdge($event.edgeId, $event.endpoint, $event.newNodeId)"
      (selectionCleared)="isExecuting ? null : boardService.clearSelection()"
      (nodeContextMenu)="isExecuting ? null : onNodeContextMenu($event, nodeCtxMenu)"
      (edgeContextMenu)="isExecuting ? null : onEdgeContextMenu($event, edgeCtxMenu)"
      (nodeDeleted)="isExecuting ? null : boardService.removeNode($event)"
      (edgeDeleted)="isExecuting ? null : boardService.removeEdge($event)"
    />

    <!-- Execution Status Panel - Always visible -->
    <div class="absolute bottom-4 left-4 right-4 bg-gray-800 border border-gray-700 rounded-lg p-3">
      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-2">
          <span class="text-sm font-medium text-gray-200">Execution Status</span>
          @if (executionStatus) {
          <span
            class="text-xs px-2 py-0.5 rounded"
            [class]="getStatusBadgeClass(executionStatus.status)"
          >
            {{ executionStatus.status }}
          </span>
          } @else {
          <span class="text-xs px-2 py-0.5 rounded bg-gray-500/20 text-gray-400">idle</span>
          }
        </div>
        <!-- Execute / Stop button -->
        <div class="flex items-center gap-2">
          @if (isExecuting) {
          <p-button
            icon="pi pi-stop"
            severity="danger"
            [text]="true"
            size="small"
            pTooltip="Stop execution"
            (onClick)="stopExecution()"
          ></p-button>
          } @else {
          <p-button
            icon="pi pi-play"
            [text]="true"
            size="small"
            pTooltip="Execute board"
            (onClick)="executeBoard()"
          ></p-button>
          }
        </div>
      </div>
      @if (executionStatus && executionStatus.edge_statuses.length) {
      <div class="space-y-1.5 max-h-32 overflow-y-auto">
        @for (es of executionStatus.edge_statuses; track es.edge_id) {
        <div class="flex items-center gap-2 text-xs">
          <span class="text-gray-400 truncate flex-1">{{ getEdgeLabel(es.edge_id) }}</span>
          @if (es.message && (es.status === 'failed' || es.status === 'skipped')) {
          <span
            class="text-gray-500 truncate max-w-45"
            [pTooltip]="es.message"
            tooltipPosition="top"
          >
            {{ es.message }}
          </span>
          }
          <button
            class="text-gray-500 hover:text-gray-300 shrink-0 cursor-pointer"
            pTooltip="View details"
            tooltipPosition="top"
            (click)="showEdgeLogs(es)"
          >
            <i class="pi pi-file-edit text-xs"></i>
          </button>
          <span
            class="px-1.5 py-0.5 rounded shrink-0"
            [class]="getStatusBadgeClass(es.status)"
          >
            {{ es.status }}
          </span>
        </div>
        }
      </div>
      } @else {
      <div class="text-xs text-gray-500">No execution in progress. Click "Execute" to start.</div>
      }
      <!-- Streaming log output - Always visible -->
      <div class="mt-2 pt-2 border-t border-gray-700">
        <div class="bg-gray-900 rounded p-2 text-xs text-gray-400 font-mono whitespace-pre-wrap leading-relaxed h-[75px] overflow-y-auto">{{ latestLogLines || 'Waiting for logs...' }}</div>
      </div>
    </div>
    }
  </div>
</div>
}

<!-- Context Menus -->
<p-contextMenu #nodeCtxMenu [model]="nodeContextMenuItems" />
<p-contextMenu #edgeCtxMenu [model]="edgeContextMenuItems" />

<!-- Board Name Dialog (Create New) -->
<p-dialog
  header="New Board"
  [(visible)]="showNameDialog"
  [modal]="true"
  [dismissableMask]="true"
  [style]="{ width: '24rem' }"
>
  <div class="space-y-3">
    <div>
      <span class="text-sm text-gray-400 mb-1 block">Name</span>
      <input
        pInputText
        class="w-full"
        [(ngModel)]="newBoardName"
        placeholder="My Sync Flow"
        (keydown.enter)="confirmCreateBoard()"
      />
    </div>
  </div>
  <div class="flex justify-end gap-2 mt-4 pt-4 border-t border-gray-700">
    <p-button label="Create" icon="pi pi-plus" (onClick)="confirmCreateBoard()"></p-button>
  </div>
</p-dialog>

<!-- Edit Board Name Dialog -->
<p-dialog
  header="Rename Board"
  [(visible)]="showEditNameDialog"
  [modal]="true"
  [dismissableMask]="true"
  [style]="{ width: '24rem' }"
>
  <div class="space-y-3">
    <div>
      <span class="text-sm text-gray-400 mb-1 block">Name</span>
      <input
        pInputText
        class="w-full"
        [(ngModel)]="editBoardName"
        placeholder="Board name"
        (keydown.enter)="confirmEditBoardName()"
      />
    </div>
  </div>
  <div class="flex justify-end gap-2 mt-4 pt-4 border-t border-gray-700">
    <p-button label="Save" icon="pi pi-save" (onClick)="confirmEditBoardName()"></p-button>
  </div>
</p-dialog>

<!-- Node Edit Dialog -->
<p-dialog
  header="Edit Node"
  [(visible)]="showNodeEditDialog"
  [modal]="true"
  [dismissableMask]="true"
  [style]="{ width: '28rem' }"
  [contentStyle]="{ overflow: 'visible' }"
>
  @if (editingNode) {
  <div class="space-y-3">
    <div>
      <span class="text-sm text-gray-400 mb-1 block">Remote</span>
      <div class="p-2 bg-gray-800 rounded text-sm">
        <span class="text-gray-300">{{ editingNode.remote_name || 'local' }}</span>
        @if (getNodeProvider(editingNode.id)) {
          <span class="text-xs text-gray-500 ml-2">({{ getNodeProvider(editingNode.id) }})</span>
        }
      </div>
    </div>
    <div>
      <span class="text-sm text-gray-400 mb-1 block">Path</span>
      <app-path-browser
        [remoteName]="editingNode.remote_name === 'local' ? '' : (editingNode.remote_name || '')"
        [path]="editNodePath"
        (pathChange)="editNodePath = $event"
        placeholder="/path/on/remote"
        filterMode="folder"
      />
    </div>
  </div>
  }
  <div class="flex justify-end gap-2 mt-4 pt-4 border-t border-gray-700">
    <p-button label="Save" icon="pi pi-save" (onClick)="saveNodeEdit()"></p-button>
  </div>
</p-dialog>

<!-- Logs Dialog -->
<p-dialog
  [header]="'Details: ' + logsDialogTitle"
  [(visible)]="showLogsDialog"
  [modal]="true"
  [dismissableMask]="true"
  [style]="{ width: '36rem' }"
>
  <div class="bg-gray-900 rounded p-3 text-sm text-gray-300 font-mono whitespace-pre-wrap max-h-96 overflow-y-auto">{{ logsDialogContent }}</div>
</p-dialog>

<!-- Edge Config Dialog -->
<app-edge-config-dialog
  [(visible)]="showEdgeDialog"
  [edge]="editingEdge"
  [sourceLabel]="editingEdgeSourceLabel"
  [targetLabel]="editingEdgeTargetLabel"
  [sourceProvider]="editingEdgeSourceProvider"
  [targetProvider]="editingEdgeTargetProvider"
  (edgeSaved)="onEdgeSaved($event)"
  (edgeDeleted)="onEdgeDeleted($event)"
/>

<!-- Schedule Dialog -->
<p-dialog
  header="Schedule Settings"
  [(visible)]="showScheduleDialog"
  [modal]="true"
  [dismissableMask]="true"
  [style]="{ width: '32rem' }"
>
  <div class="space-y-4">
    <!-- Enable/Disable Schedule -->
    <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg">
      <div>
        <p class="text-sm font-medium text-gray-200">Enable Schedule</p>
        <p class="text-xs text-gray-500">Automatically run this board on a schedule</p>
      </div>
      <p-toggleswitch [(ngModel)]="scheduleEnabled"></p-toggleswitch>
    </div>

    @if (scheduleEnabled) {
    <!-- Frequency Selection -->
    <div>
      <span class="text-sm text-gray-400 mb-2 block">Frequency</span>
      @if (!useCustomCron) {
      <!-- Preset mode -->
      <p-select
        [options]="frequencyPresets"
        [ngModel]="scheduleCronExpr"
        (ngModelChange)="onPresetChange($event)"
        optionLabel="label"
        optionValue="value"
        styleClass="w-full"
        placeholder="Select frequency"
      ></p-select>
      <button
        class="text-xs text-primary-400 hover:text-primary-300 mt-2 cursor-pointer bg-transparent border-none p-0"
        (click)="useCustomCron = true"
      >
        <i class="pi pi-pencil text-[10px] mr-1"></i>Custom expression
      </button>
      } @else {
      <!-- Custom mode: 5 cron field dropdowns -->
      <div class="grid grid-cols-5 gap-2">
        <div>
          <!-- eslint-disable-next-line @angular-eslint/template/label-has-associated-control -->
          <label class="text-[10px] text-gray-500 block mb-1">Min</label>
          <p-select
            [options]="minuteOptions"
            [(ngModel)]="cronParts.minute"
            (ngModelChange)="onCronPartChange()"
            optionLabel="label"
            optionValue="value"
            styleClass="w-full"
          ></p-select>
        </div>
        <div>
          <!-- eslint-disable-next-line @angular-eslint/template/label-has-associated-control -->
          <label class="text-[10px] text-gray-500 block mb-1">Hour</label>
          <p-select
            [options]="hourOptions"
            [(ngModel)]="cronParts.hour"
            (ngModelChange)="onCronPartChange()"
            optionLabel="label"
            optionValue="value"
            styleClass="w-full"
          ></p-select>
        </div>
        <div>
          <!-- eslint-disable-next-line @angular-eslint/template/label-has-associated-control -->
          <label class="text-[10px] text-gray-500 block mb-1">Day</label>
          <p-select
            [options]="domOptions"
            [(ngModel)]="cronParts.dom"
            (ngModelChange)="onCronPartChange()"
            optionLabel="label"
            optionValue="value"
            styleClass="w-full"
          ></p-select>
        </div>
        <div>
          <!-- eslint-disable-next-line @angular-eslint/template/label-has-associated-control -->
          <label class="text-[10px] text-gray-500 block mb-1">Month</label>
          <p-select
            [options]="monthOptions"
            [(ngModel)]="cronParts.month"
            (ngModelChange)="onCronPartChange()"
            optionLabel="label"
            optionValue="value"
            styleClass="w-full"
          ></p-select>
        </div>
        <div>
          <!-- eslint-disable-next-line @angular-eslint/template/label-has-associated-control -->
          <label class="text-[10px] text-gray-500 block mb-1">Weekday</label>
          <p-select
            [options]="dowOptions"
            [(ngModel)]="cronParts.dow"
            (ngModelChange)="onCronPartChange()"
            optionLabel="label"
            optionValue="value"
            styleClass="w-full"
          ></p-select>
        </div>
      </div>
      <button
        class="text-xs text-primary-400 hover:text-primary-300 mt-2 cursor-pointer bg-transparent border-none p-0"
        (click)="useCustomCron = false"
      >
        <i class="pi pi-arrow-left text-[10px] mr-1"></i>Back to presets
      </button>
      }
      <!-- Preview -->
      <p class="text-xs text-gray-500 mt-3 p-2 bg-gray-800 rounded">
        <i class="pi pi-clock text-[10px] mr-1"></i>{{ getCronDescription() }}
      </p>
    </div>

    <!-- Last Run Info -->
    @if (activeBoard?.last_run) {
    <div class="p-3 bg-gray-800 rounded-lg">
      <div class="flex items-center justify-between text-xs">
        <span class="text-gray-500">Last run:</span>
        <span class="text-gray-300">{{ activeBoard?.last_run }}</span>
      </div>
      @if (activeBoard?.last_result) {
      <div class="flex items-center justify-between text-xs mt-1">
        <span class="text-gray-500">Result:</span>
        <span
          class="px-2 py-0.5 rounded"
          [class]="getStatusBadgeClass(activeBoard?.last_result || '')"
        >
          {{ activeBoard?.last_result }}
        </span>
      </div>
      }
    </div>
    }
    }
  </div>

  <div class="flex justify-end gap-2 mt-4 pt-4 border-t border-gray-700">
    <p-button label="Save" icon="pi pi-save" (onClick)="saveSchedule()"></p-button>
  </div>
</p-dialog>
