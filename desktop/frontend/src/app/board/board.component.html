@if (viewMode === 'list') {
<!-- ========== LIST VIEW ========== -->
<div class="flex flex-col h-full">
  <p-toolbar>
    <ng-template #start>
      <div class="flex items-center gap-3">
        <i class="pi pi-sitemap text-primary-400"></i>
        <h1 class="text-lg font-semibold text-gray-100">Boards</h1>
        @if (boards.length) {
        <span class="text-sm text-gray-500">({{ boards.length }})</span>
        }
      </div>
    </ng-template>
    <ng-template #end>
      <p-button
        icon="pi pi-plus"
        label="New Board"
        size="small"
        (onClick)="createNewBoard()"
      ></p-button>
    </ng-template>
  </p-toolbar>

  <div class="flex-1 overflow-auto p-4">
    <div class="max-w-4xl mx-auto">
      @if (boards.length) {
      <div class="space-y-3" role="list">
        @for (board of boards; track board.id) {
        <p-card
          styleClass="group hover:bg-gray-700 transition-colors duration-200 cursor-pointer"
          (click)="openBoard(board)"
        >
          <div class="flex items-center gap-3">
            <div class="shrink-0">
              <div class="w-10 h-10 bg-gray-700 group-hover:bg-gray-600 rounded-lg flex items-center justify-center transition-colors">
                <i class="pi pi-sitemap text-primary-400"></i>
              </div>
            </div>
            <div class="flex-1 min-w-0">
              <h3 class="text-sm font-medium text-gray-200 truncate">
                {{ board.name || '(Unnamed board)' }}
              </h3>
              <p class="text-xs text-gray-500 mt-0.5">{{ getBoardSummary(board) }}</p>
            </div>
            <div class="flex items-center gap-1 shrink-0 opacity-0 group-hover:opacity-100 transition-opacity">
              <p-button
                icon="pi pi-pencil"
                severity="secondary"
                [text]="true"
                [rounded]="true"
                size="small"
                pTooltip="Edit"
                (onClick)="openBoard(board); $event.stopPropagation()"
              ></p-button>
              <p-button
                icon="pi pi-trash"
                severity="danger"
                [text]="true"
                [rounded]="true"
                size="small"
                pTooltip="Delete"
                (onClick)="deleteBoardConfirm(board); $event.stopPropagation()"
              ></p-button>
            </div>
          </div>
        </p-card>
        }
      </div>
      } @else {
      <!-- Empty state -->
      <div class="flex flex-col items-center justify-center py-16 text-gray-500">
        <div class="w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mb-4">
          <i class="pi pi-sitemap text-3xl text-gray-400"></i>
        </div>
        <h2 class="text-xl font-bold text-gray-100 mb-2">No Boards</h2>
        <p class="text-gray-400 mb-6">Create a board to start building sync flows</p>
        <p-button
          icon="pi pi-plus"
          label="Create Board"
          (onClick)="createNewBoard()"
        ></p-button>
      </div>
      }
    </div>
  </div>
</div>
} @else {
<!-- ========== EDITOR VIEW ========== -->
<div class="flex flex-col h-full">
  <p-toolbar>
    <ng-template #start>
      <div class="flex items-center gap-3">
        <p-button
          icon="pi pi-arrow-left"
          severity="secondary"
          [text]="true"
          [rounded]="true"
          size="small"
          pTooltip="Back to boards"
          (onClick)="backToList()"
        ></p-button>
        <i class="pi pi-sitemap text-primary-400"></i>
        <h1 class="text-lg font-semibold text-gray-100">
          {{ activeBoard?.name || '(Unnamed board)' }}
        </h1>
      </div>
    </ng-template>
    <ng-template #end>
      @if (activeBoard) {
      <div class="flex items-center gap-2">
        <!-- Add Node -->
        <p-select
          [options]="remoteOptions"
          [(ngModel)]="selectedRemoteToAdd"
          (ngModelChange)="addNodeFromRemote($event)"
          optionLabel="label"
          optionValue="value"
          placeholder="Add Remote"
          styleClass="w-36"
        />
        <div class="border-l border-gray-600 h-6 mx-1"></div>
        <!-- Save -->
        <p-button
          icon="pi pi-save"
          severity="secondary"
          size="small"
          label="Save"
          (onClick)="saveBoard()"
        ></p-button>
        <!-- Execute / Stop -->
        @if (isExecuting) {
        <p-button
          icon="pi pi-stop"
          severity="danger"
          size="small"
          label="Stop"
          (onClick)="stopExecution()"
        ></p-button>
        } @else {
        <p-button
          icon="pi pi-play"
          size="small"
          label="Execute"
          (onClick)="executeBoard()"
        ></p-button>
        }
      </div>
      }
    </ng-template>
  </p-toolbar>

  <!-- Canvas Area -->
  <div class="flex-1 overflow-hidden relative">
    @if (activeBoard) {
    <app-board-canvas
      [nodes]="activeBoard.nodes || []"
      [edges]="activeBoard.edges || []"
      [selectedNodeId]="(boardService.selectedNodeId$ | async) ?? null"
      [selectedEdgeId]="(boardService.selectedEdgeId$ | async) ?? null"
      [executionStatus]="(boardService.executionStatus$ | async) ?? null"
      (nodeSelected)="boardService.selectNode($event)"
      (nodeDoubleClicked)="openNodeEditDialog($event)"
      (edgeSelected)="boardService.selectEdge($event)"
      (edgeDoubleClicked)="openEdgeDialog($event)"
      (nodeMoved)="boardService.moveNode($event.nodeId, $event.x, $event.y)"
      (edgeCreated)="boardService.addEdge($event.sourceId, $event.targetId)"
      (selectionCleared)="boardService.clearSelection()"
      (nodeContextMenu)="onNodeContextMenu($event, nodeCtxMenu)"
      (edgeContextMenu)="onEdgeContextMenu($event, edgeCtxMenu)"
    />

    <!-- Execution Status Panel -->
    @if (executionStatus) {
    <div class="absolute bottom-4 left-4 right-4 bg-gray-800 border border-gray-700 rounded-lg p-3">
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm font-medium text-gray-200">Execution Status</span>
        <span
          class="text-xs px-2 py-0.5 rounded"
          [class]="getStatusBadgeClass(executionStatus.status)"
        >
          {{ executionStatus.status }}
        </span>
      </div>
      <div class="space-y-1.5 max-h-32 overflow-y-auto">
        @for (es of executionStatus.edge_statuses; track es.edge_id) {
        <div class="flex items-center gap-2 text-xs">
          <span class="text-gray-400 truncate flex-1">{{ getEdgeLabel(es.edge_id) }}</span>
          @if (es.message && (es.status === 'failed' || es.status === 'skipped')) {
          <span
            class="text-gray-500 truncate max-w-45"
            [pTooltip]="es.message"
            tooltipPosition="top"
          >
            {{ es.message }}
          </span>
          }
          <button
            class="text-gray-500 hover:text-gray-300 shrink-0 cursor-pointer"
            pTooltip="View details"
            tooltipPosition="top"
            (click)="showEdgeLogs(es)"
          >
            <i class="pi pi-file-edit text-xs"></i>
          </button>
          <span
            class="px-1.5 py-0.5 rounded shrink-0"
            [class]="getStatusBadgeClass(es.status)"
          >
            {{ es.status }}
          </span>
        </div>
        }
      </div>
      <!-- Streaming log output -->
      @if (latestLogLines) {
      <div class="mt-2 pt-2 border-t border-gray-700">
        <div class="bg-gray-900 rounded p-2 text-xs text-gray-400 font-mono whitespace-pre-wrap leading-relaxed max-h-16 overflow-hidden">{{ latestLogLines }}</div>
      </div>
      }
    </div>
    }
    }
  </div>
</div>
}

<!-- Context Menus -->
<p-contextMenu #nodeCtxMenu [model]="nodeContextMenuItems" />
<p-contextMenu #edgeCtxMenu [model]="edgeContextMenuItems" />

<!-- Board Name Dialog -->
<p-dialog
  header="New Board"
  [(visible)]="showNameDialog"
  [modal]="true"
  [dismissableMask]="true"
  [style]="{ width: '24rem' }"
>
  <div class="space-y-3">
    <div>
      <span class="text-sm text-gray-400 mb-1 block">Name</span>
      <input
        pInputText
        class="w-full"
        [(ngModel)]="newBoardName"
        placeholder="My Sync Flow"
        (keydown.enter)="confirmCreateBoard()"
      />
    </div>
  </div>
  <div class="flex justify-end gap-2 mt-4 pt-4 border-t border-gray-700">
    <p-button label="Cancel" severity="secondary" (onClick)="showNameDialog = false"></p-button>
    <p-button label="Create" icon="pi pi-plus" (onClick)="confirmCreateBoard()"></p-button>
  </div>
</p-dialog>

<!-- Node Edit Dialog -->
<p-dialog
  header="Edit Node"
  [(visible)]="showNodeEditDialog"
  [modal]="true"
  [dismissableMask]="true"
  [style]="{ width: '28rem' }"
  [contentStyle]="{ overflow: 'visible' }"
>
  @if (editingNode) {
  <div class="space-y-3">
    <div>
      <span class="text-sm text-gray-400 mb-1 block">Remote</span>
      <div class="p-2 bg-gray-800 rounded text-gray-300 text-sm">
        {{ editingNode.remote_name || 'local' }}
      </div>
    </div>
    <div>
      <span class="text-sm text-gray-400 mb-1 block">Label</span>
      <input
        pInputText
        class="w-full"
        [(ngModel)]="editNodeLabel"
        [placeholder]="editingNode.remote_name || 'Label'"
      />
    </div>
    <div>
      <span class="text-sm text-gray-400 mb-1 block">Path</span>
      <app-path-browser
        [remoteName]="editingNode.remote_name === 'local' ? '' : (editingNode.remote_name || '')"
        [path]="editNodePath"
        (pathChange)="editNodePath = $event"
        placeholder="/path/on/remote"
        filterMode="folder"
      />
    </div>
  </div>
  }
  <div class="flex justify-end gap-2 mt-4 pt-4 border-t border-gray-700">
    <p-button label="Cancel" severity="secondary" (onClick)="showNodeEditDialog = false"></p-button>
    <p-button label="Save" icon="pi pi-save" (onClick)="saveNodeEdit()"></p-button>
  </div>
</p-dialog>

<!-- Logs Dialog -->
<p-dialog
  [header]="'Details: ' + logsDialogTitle"
  [(visible)]="showLogsDialog"
  [modal]="true"
  [dismissableMask]="true"
  [style]="{ width: '36rem' }"
>
  <div class="bg-gray-900 rounded p-3 text-sm text-gray-300 font-mono whitespace-pre-wrap max-h-96 overflow-y-auto">{{ logsDialogContent }}</div>
  <div class="flex justify-end mt-4 pt-4 border-t border-gray-700">
    <p-button label="Close" severity="secondary" (onClick)="showLogsDialog = false"></p-button>
  </div>
</p-dialog>

<!-- Edge Config Dialog -->
<app-edge-config-dialog
  [(visible)]="showEdgeDialog"
  [edge]="editingEdge"
  [sourceLabel]="editingEdgeSourceLabel"
  [targetLabel]="editingEdgeTargetLabel"
  (edgeSaved)="onEdgeSaved($event)"
  (edgeDeleted)="onEdgeDeleted($event)"
/>
